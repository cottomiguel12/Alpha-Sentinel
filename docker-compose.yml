services:

  sentinel-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    working_dir: /app
    env_file:
      - .env
      - .secrets.env
    environment:
      DB_PATH: /data/sentinel.db
      LOG_PATH: /logs/sentinel.log
      API_PORT: "8001"
      ALERTS_SOURCE: "live"
      UW_ENABLED: "0"
      UW_BASE_URL: "https://api.unusualwhales.com"
    volumes:
      - ./AlphaSentinel-data:/data
      - sentinel_logs:/logs
    networks: [ core_net ]
    restart: unless-stopped
    ports:
      - "127.0.0.1:8001:8001"

  sentinel-agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    working_dir: /app
    env_file: [ .env ]
    environment:
      DB_PATH: /data/sentinel.db
      LOG_PATH: /logs/agent.log
      OPTIONS_CSVS: "/data/new_etfs.csv,/data/new_stocks.csv"
      # OPTIONS_CSV: ""  # legacy single-file fallback (leave blank when OPTIONS_CSVS is set)
      AGENT_INTERVAL_SEC: "1.5"
      MAX_ALERTS_PER_TICK: "25"
      REPLAY_FROM_START: "1"
      WATCHLIST_REFRESH_SEC: "5"
      UW_ENABLED: "0"
      UW_API_KEY: ""
      UW_BASE_URL: "https://api.unusualwhales.com"
      UW_MODE: "poll"
      UW_POLL_SEC: "2"
      UW_RATE_LIMIT_SLEEP: "0.25"
    volumes:
      - ./AlphaSentinel-data:/data
      - ./config:/app/config:ro
      - sentinel_logs:/logs
    networks: [ core_net ]

  sentinel-sim:
    build:
      context: .
      dockerfile: Dockerfile.agent
    working_dir: /app
    env_file: [ .env ]
    environment:
      DB_PATH: /data/sentinel.db
    volumes:
      - ./AlphaSentinel-data:/data
      - sentinel_logs:/logs
    command: [ "python", "-m", "app.sim" ]
    networks: [ core_net ]
    restart: unless-stopped
    depends_on: [ sentinel-api ]

  sentinel-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    networks: [ core_net ]
    restart: unless-stopped
    ports:
      - "0.0.0.0:3000:80"
    depends_on: [ sentinel-api ]

networks:
  core_net:
    external: true

volumes:
  sentinel_data:
  sentinel_logs:
